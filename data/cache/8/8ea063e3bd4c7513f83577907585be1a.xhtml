
<h1 class="sectionedit1" id="spatial_covariance">Spatial Covariance</h1>
<div class="level1">

<p>
Back to <a href="/dokuwiki/doku.php?id=wiki:rstat:r_geography" class="wikilink1" title="wiki:rstat:r_geography"> Spatial analysis in R</a> <strong>main menu</strong>.<br/>

<br/>

In probability theory and statistics, <a href="https://en.wikipedia.org/wiki/Covariance_function" class="urlextern" target="blanc" title="https://en.wikipedia.org/wiki/Covariance_function" rel="nofollow noopener"> covariance</a> is a measure of how much two variables change together. While dealing with spatial statistics we test the geographical induced changes and analyze the <strong>spatial covariance</strong> between variable in pairwise correlations between locations. We can define the degree of the intensity (how much) and direction (same direction or inverse correlation) of the variation.<br/>

While analysing the spatial covariance on a broad area, we define spatial <strong>stationarity</strong> or <strong>non-stationarity</strong> of the spatial covariance: That is if correlation are stable within a determined region or if they change in intensity and direction depending on the sub-region within an area, respectively. <br/>

A classical example <a href="https://www.stat.washington.edu/research/reports/1992/tr236.pdf" class="urlextern" target="blanc" title="https://www.stat.washington.edu/research/reports/1992/tr236.pdf" rel="nofollow noopener"> Guttorp and Samsong 1992</a> on the use of spatial covariance is the selection of redundant field monitoring sites within a network of environmental sensors. How we design the distribution of senors, should we remove and move redundant stations. We can test if our monitoring sites produce correlates recordings or not, if data are strongly related between stations we might choose to move a station in a area where data are more needed in unmonitored area.<br/>

</p>

<p>
In R we can use SpatialPack to asses the significance of the correlation between two spatial processes.<br/>

</p>

</div>
<!-- EDIT1 SECTION "Spatial Covariance" [1-1539] -->
<h2 class="sectionedit2" id="references">References</h2>
<div class="level2">

<p>
Reference of this analisys can be found in <a href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0068437" class="urlextern" target="blanc" title="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0068437" rel="nofollow noopener"> Casalegno et al. 2013</a> and <a href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0107822" class="urlextern" target="blanc" title="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0107822" rel="nofollow noopener"> 2014</a> which are applications following the more theoretical and statistical approaches explained by the folowing:
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://dx.doi.org/10.2307/2532039" class="urlextern" target="blanc" title="http://dx.doi.org/10.2307/2532039" rel="nofollow noopener">Clifford P, Richardson S, Hemon D (1989)</a>  Assessing the significance of the correlation between two spatial processes. Biometrics 45: 123–134.</div>
</li>
<li class="level1"><div class="li"> <a href="http://dx.doi.org/10.2307/2532625" class="urlextern" target="blanc" title="http://dx.doi.org/10.2307/2532625" rel="nofollow noopener"> Dutilleul P (1993) </a> Modifying the t test for assessing the correlation between two spatial processes. Biometrics 49: 305–314.</div>
</li>
<li class="level1"><div class="li"> <a href="http://dx.doi.org/10.2307/2265776" class="urlextern" target="blanc" title="http://dx.doi.org/10.2307/2265776" rel="nofollow noopener">Thomson JD, Weiblen BA, Thomson BA, Alfaro S, Legendre P (1996) </a> Untangling multiple factors in spatial distributions: Lilies, Gophers, and Rocks. Ecology 77: 1698–1715.</div>
</li>
<li class="level1"><div class="li"> <a href="http://dx.doi.org/10.1046/j.1523-1739.1999.98364.x" class="urlextern" target="blanc" title="http://dx.doi.org/10.1046/j.1523-1739.1999.98364.x" rel="nofollow noopener"> Carroll C, Zielinski W, Noss R (1999) </a> Using presence-absence data to build and test spatial habitat models for the fisher in the Klamath region, USA Cons. Biol. 13: 1344–1359.</div>
</li>
<li class="level1"><div class="li"> <a href="http://dx.doi.org/10.1111/j.2007.0906-7590.05171.x" class="urlextern" target="blanc" title="http://dx.doi.org/10.1111/j.2007.0906-7590.05171.x" rel="nofollow noopener">Dormann CF, McPherson JM, Araujo MB, Bivand R, Bolliger J, et al. (2007)</a> Methods to account for spatial autocorrelation in the analysis of species distributional data. Ecography 30: 609–628.</div>
</li>
<li class="level1"><div class="li"> Zar JH (2007) Biostatistical analysis. Upper Saddle River, NJ. Prentice Hall, 960 pag.</div>
</li>
<li class="level1"><div class="li"> Benjamini Y, Hochberg Y (1995) Controlling the false discovery rate: a practical and powerful approach to multiple testing. J. Roy. Statist. Soc. Ser. B 57: 289–300.</div>
</li>
<li class="level1"><div class="li"> <a href="https://www.stat.washington.edu/research/reports/1992/tr236.pdf" class="urlextern" target="blanc" title="https://www.stat.washington.edu/research/reports/1992/tr236.pdf" rel="nofollow noopener"> Guttorp and Samsong 1992</a> Methods for estimating heterogeneous spatial covariance function with environmental applications.</div>
</li>
</ul>
<div class="noteimportant">N.B. We have downloaded the maps needed here during the previous tutorial on raster <a href="/dokuwiki/doku.php?id=wiki:rstat:r_load_rast" class="wikilink1" title="wiki:rstat:r_load_rast"> data visualization</a>.
</div>
<p>
If you have already downloaded the maps, you can migrate into their folder, start an R session and load them using :
</p>
<pre class="code R"># LOAD RASTERS
library(rgdal)
library(raster)
map_names=c(&quot;agri_m9.asc&quot;,&quot;carA_m9.asc&quot;,&quot;carS_m9.asc&quot;,&quot;mitR_m9.asc&quot;,&quot;prod_m9.asc&quot;,&quot;pvl_R_m9.asc&quot;,&quot;recA_m9.asc&quot;,&quot;recL_m9.asc&quot;,&quot;recT_m9.asc&quot;,&quot;urbR_m9.asc&quot;,&quot;winR_m9.asc&quot;,&quot;ZONES_m9.asc&quot;)
import12=vector(&quot;list&quot;,12)
for ( x in c(1:12) ){ 
import12[[x]]=raster(readGDAL(map_names[x]))
}
MAPS=brick(import12[[1]],import12[[2]],import12[[3]],import12[[4]],import12[[5]],immport12[[11]],import12[[12]])
&nbsp;
# LOAD VECTORS
stat = read.csv(&quot;SYNT_2002.csv&quot;, header=T)
ward &lt;- shapefile(&quot;cornwall.shp&quot;)
agri &lt;- merge(ward, stat, by.x='PI', by.y='ID')</pre>

</div>
<!-- EDIT2 SECTION "References" [1540-4296] -->
<h2 class="sectionedit3" id="spatial_covariance_between_vector_maps">Spatial covariance between vector maps</h2>
<div class="level2">

<p>
We can use the agricultural statistics available as vector layer and test significance, direction and intensity of correlation between spatial patterns of distribution between crop and livestock types. As an example we can test the distribution of mature and young bovines livestocks and expect them to be highly correlated as well as should be different cereals types spatial distributions.<br/>

Here we compare different features (crop/ livestock type) within the same geographical units (polygons of  administrative boundary) so is fine to use centroids of polygons as geographical dimension.<br/>

We are going to use the Clifford, Hemond and Richardson modified t test available in the <a href="http://www.inside-r.org/packages/cran/SpatialPack/docs/modified.ttest" class="urlextern" target="blanc" title="http://www.inside-r.org/packages/cran/SpatialPack/docs/modified.ttest" rel="nofollow noopener"> R SpatialPack</a> wich performs a modified version of the t test to assess the correlation between two spatial processes. To use this method, we rank transform the variables and compute the Pearson&#039;s coefficient adjusted for spatial autocorrelation.<br/>

In case of comparison between different vector layers (different polygon distributions) the <a href="https://cran.r-project.org/web/packages/spatialCovariance/spatialCovariance.pdf" class="urlextern" target="blanc" title="https://cran.r-project.org/web/packages/spatialCovariance/spatialCovariance.pdf" rel="nofollow noopener">SpatialCovariance</a> R package could be applied 
</p>
<pre class="code r">install.packages(&quot;SpatialPack&quot;)
library(SpatialPack)
&nbsp;
# Compare young and mature beef lifestocks.
modified.ttest(rank(agri@data$cattle_under1yr_v),rank(agri@data$beef_v),coordinates(coordinates(agri)))
# F-statistic: 89.6019 on 1 and 134.5361 DF, p-value: 0 
# alternative hypothesis: true autocorrelation is not equal to 0
# sample correlation: 0.6323</pre>
<ul>
<li class="level1"><div class="li">First we look at the p-value p-value which tells you the probability of observing an effect due to chance alone. If the probability is lower then 5% (p-value ⇐ 0.05) our results are significant and not due to chance according to statistical conventions.</div>
</li>
<li class="level1"><div class="li">Then we can look at intensity and direction of the correlation (between -1 and +1) and we found a positive and intense spatial correlation between variables (0.6).</div>
</li>
</ul>

<p>
As an example we found a lesser intense correlation between dairy and beef livestocks distributions.
</p>
<pre class="code r">modified.ttest(rank(agri@data$dairy),rank(agri@data$beef_v),coordinates(coordinates(agri)))
# F-statistic: 5.6505 on 1 and 140.7158 DF, p-value: 0.0188 
# alternative hypothesis: true autocorrelation is not equal to 0
# sample correlation: 0.1965</pre>

</div>
<!-- EDIT3 SECTION "Spatial covariance between vector maps" [4297-6745] -->
<h2 class="sectionedit4" id="spatial_covariance_between_raster_maps">Spatial covariance between raster maps</h2>
<div class="level2">

<p>
We have loaded a set of raster data including different ecosystem and environmental services (natural capitals) for Cornwall:
</p>
<ul>
<li class="level1"><div class="li"> Agricultural value</div>
</li>
<li class="level1"><div class="li"> Carbon above ground</div>
</li>
<li class="level1"><div class="li"> Carbon in soil</div>
</li>
<li class="level1"><div class="li"> Flood mitigation </div>
</li>
<li class="level1"><div class="li"> Primary plant productivity</div>
</li>
<li class="level1"><div class="li"> Renewable - Wind energy </div>
</li>
<li class="level1"><div class="li"> Renewable - solar energy</div>
</li>
<li class="level1"><div class="li"> Aesthetic value of landscapes</div>
</li>
<li class="level1"><div class="li"> recreational value</div>
</li>
<li class="level1"><div class="li"> Touristic value</div>
</li>
<li class="level1"><div class="li"> Urban development</div>
</li>
</ul>

<p>
Additionally we have a map of zones in Corwall: costal areas, east, central and west. We can test spatial covariance between all these layers in the overall study area and within zones.
</p>

<p>
We have <a href="/dokuwiki/doku.php?id=wiki:rstat:r_load_rast" class="wikilink1" title="wiki:rstat:r_load_rast"> previously</a> learned how to visualize these maps in R.<br/>

</p>

<p>
We can perform some zonal statistics to look at discrepencies of services in the overall study area and within zones thereoff.<br/>

</p>
<pre class="code r">TITLE=c(&quot;Agriculture value&quot;,&quot;Carbon above ground&quot;,&quot;Carbon in soil&quot;,&quot;Flood mitigation&quot;,&quot;Plant production&quot;,&quot;Solar energy&quot;,&quot;Aesthetic&quot;,&quot;Recreation&quot;,&quot;Tourism&quot;,&quot;Urban development&quot;,&quot;Wind energy&quot;,&quot;Zones of Cornwall&quot;)
tiff(&quot;Zonal statistics.tif&quot;, width = 800, height = 900)
nf &lt;- layout(matrix(c(1:12),4,3,byrow=TRUE), c(1,1), c(1,1), TRUE) ; layout.show(nf) ; par(mar=c(5,5,3,1))
for (band in c(1,2,3,4,5,7,8,9,10,11,6)) {
COS=subset(na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==1]), na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==1]&gt;0))
WES=subset(na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==2]), na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==2]&gt;0))
CEN=subset(na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==3]), na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==3]&gt;0))
EAS=subset(na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==4]), na.omit(MAPS@data@values[,band][MAPS@data@values[,12]==4]&gt;0))
ALL=subset(na.omit(MAPS@data@values[,band][MAPS@data@values[,12]!=5]), na.omit(MAPS@data@values[,band][MAPS@data@values[,12]!=5]&gt;0))
boxplot(COS,WES,CEN,EAS,ALL, col=(c(&quot;blue&quot;,&quot;red&quot;,&quot;green4&quot;,&quot;orange&quot;,&quot;grey&quot;)),main=TITLE[band], cex.main=2,cex.axis=1.5)
}
plot(1,1,type=&quot;n&quot;,xlab=&quot;&quot;,ylab=&quot;&quot;,axes=F)
legend(0.7,1.5,c(&quot;Coastal&quot;,&quot;West&quot;,&quot;Centre&quot;,&quot;East&quot;,&quot;Overall&quot;), bty = &quot;n&quot;,  pch=c(15,15,15,15), pt.cex=c(2.5,2.5,2.5),  cex=2.5,  col=c(&quot;blue&quot;,&quot;red&quot;,&quot;green4&quot;,&quot;orange&quot;,&quot;gray&quot;))
dev.off()
&nbsp;</pre>

<p>
The output image show the median value (central line), upper quartile (edges of boxes), maximum and minimum values excluding outliers (whiskers) and outliers (dots) of environmental services maps in Cornwall and within zones thereof.
<br/>

<a href="/dokuwiki/lib/exe/detail.php?id=wiki%3Arstat%3Ar_spat_covar&amp;media=wiki:rstat:zonalstat_r.png" class="media" title="wiki:rstat:zonalstat_r.png"><img src="/dokuwiki/lib/exe/fetch.php?w=300&amp;tok=b1ab3b&amp;media=wiki:rstat:zonalstat_r.png" class="media" alt="" width="300" /></a>
</p>

<p>
Now we can look at the spatial covariance between agriculture and carbon stocks above and below the soil:
</p>
<pre class="code r">XYcoor=xyFromCell(Agri,1:12769)
Agri=import12[[1]]
CarSoil=import12[[3]]
Agri.CarSoil&lt;-na.omit(data.frame(Agri@data@values,CarSoil@data@values,XYcoor))
modified.ttest(rank(Agri.CarSoil[[1]]),rank(Agri.CarSoil[[2]]),matrix(ncol=2,nrow=length(Agri.CarSoil[[1]]),c(Agri.CarSoil[[3]],Agri.CarSoil[[4]])))
# Corrected Pearson’s correlation for spatial autocorrelation
# 
# F-statistic: 11.2706 on 1 and 350.2359 DF, p-value: 9e-04
# alternative hypothesis: true autocorrelation is not equal to 0
# sample correlation: -0.1766</pre>

<p>
We found statistical significant correlation of low intensity and inverse direction.<br/>

</p>

<p>
Additional statistics can be performed and the analyses of all pairwise correlations can be carried out per each distinct sub zone. More specifications and R scripting are available at this <a href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0107822" class="urlextern" target="blanc" title="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0107822" rel="nofollow noopener"> PloS ONE</a> paper. As an example the code below perform the whole set of correlations by the following steps:<br/>

</p>
<ul>
<li class="level1"><div class="li"> Create an object list with five elements, each element corresponding to the overall study area and the zone therein; this lists <em>zMAP</em> is created for storing raster grid cell values (in total 12769), corresponding to each of the twelve environmental service layers.<br/>
  * Create a second object list with the same elements as above but only storing a the resulting Pearson&#039;s (spatial correlation adjusted) values in a matrix of 11 x 11 binary intersections between layers.</div>
</li>
<li class="level1"><div class="li"> Create a third layer as above for storing p-values.</div>
</li>
<li class="level1"><div class="li"> Create a matrix <em>coords</em> for storing lat long coordinates of each grid cell of the study area.</div>
</li>
<li class="level1"><div class="li"> Build a loop for each zone within the study area and an embedded loop in the loop for computing p-value and correlation coefficients between each pairwise combination of layers.</div>
</li>
<li class="level1"><div class="li"> Compute p-values and correlation coefficients for the whole study area. </div>
</li>
</ul>
<pre class="code r">zMAP=vector(&quot;list&quot;,5)
zMAP[[5]]=matrix(ncol=12,nrow=12769)
zCORR=vector(&quot;list&quot;,5)
zPVAL=vector(&quot;list&quot;,5)
coords=matrix(ncol=2,nrow=12769)
coords=xyFromCell(MAPS,1:12769)
&nbsp;
for ( ZONE in c(1:4)){
zMAP[[ZONE]]=MAPS[MAPS@data@values[,12]==ZONE]
zCORR[[ZONE]]=matrix(ncol=11,nrow=11)
zPVAL[[ZONE]]=matrix(ncol=11,nrow=11)
for ( x in c(1:11)){
for ( y in c(1:11)){
xdata=na.omit(data.frame(zMAP[[ZONE]][,x],data.frame(zMAP[[ZONE]][,y],coords[which(MAPS@data@values[,12]==ZONE),1],coords[which(MAPS@data@values[,12]==ZONE),2])))
temp=modified.ttest(rank(xdata[[1]]),rank(xdata[[2]]),matrix(ncol=2,nrow=length(xdata[[1]]),c(xdata[[3]],xdata[[4]]))) 
zCORR[[ZONE]][x,y]=temp$corr
zPVAL[[ZONE]][x,y]=temp$p.value
}}}
&nbsp;
ZONE=5 
zMAP[[ZONE]]=MAPS@data@values
zCORR[[ZONE]]=matrix(ncol=11,nrow=11) 
zPVAL[[ZONE]]=matrix(ncol=11,nrow=11)
for ( x in c(1:11)){for ( y in c(1:11)){ 
xdata=na.omit(data.frame(zMAP[[ZONE]][,x],data.frame(zMAP[[ZONE]][,y],coords[,1],coords[,2])))
temp=modified.ttest(rank(xdata[[1]]),rank(xdata[[2]]),matrix(ncol=2,nrow=length(xdata[[1]]),c(xdata[[3]],xdata[[4]]))) 
zCORR[[ZONE]][x,y]=temp$corr
zPVAL[[ZONE]][x,y]=temp$p.value
}}</pre>

</div>
<!-- EDIT4 SECTION "Spatial covariance between raster maps" [6746-] -->